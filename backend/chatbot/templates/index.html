<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YuhHearDem </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Clean YuhHearDem Styles */
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gradient-bg {
            background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 90%),
                        radial-gradient(circle at 80% 30%, rgba(99, 102, 241, 0.18) 0%, transparent 95%),
                        radial-gradient(circle at 60% 80%, rgba(6, 182, 212, 0.12) 0%, transparent 85%),
                        radial-gradient(circle at 30% 70%, rgba(139, 92, 246, 0.08) 0%, transparent 80%),
                        radial-gradient(circle at 85% 85%, rgba(34, 211, 238, 0.1) 0%, transparent 85%),
                        linear-gradient(135deg, 
                            rgba(255, 255, 255, 1) 0%, 
                            rgba(252, 254, 255, 1) 25%, 
                            rgba(248, 250, 252, 0.99) 40%, 
                            rgba(241, 245, 249, 0.97) 60%, 
                            rgba(226, 232, 240, 0.9) 80%, 
                            rgba(203, 213, 225, 0.8) 95%, 
                            rgba(148, 163, 184, 0.7) 100%
                        );
        }

        /* Thinking dots animation */
        .thinking-dots-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 1rem 0;
            margin-left: 44px;
        }

        .thinking-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: #64748b;
            border-radius: 50%;
            animation: thinking-bounce 1.4s ease-in-out infinite;
        }

        .thinking-dot:nth-child(1) { animation-delay: 0s; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes thinking-bounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-12px);
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Enhanced YouTube link styling */
        .message-bubble .text-gray-800 a[href*="youtube.com"],
        .message-bubble .text-gray-800 a[href*="youtu.be"] {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #dc2626;
            text-decoration: none;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fecaca;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin: 0.25rem 0.25rem 0.25rem 0;
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.1);
        }

        .message-bubble .text-gray-800 a[href*="youtube.com"]:hover,
        .message-bubble .text-gray-800 a[href*="youtu.be"]:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
            color: #b91c1c;
        }

        .message-bubble .text-gray-800 a[href*="youtube.com"]:before,
        .message-bubble .text-gray-800 a[href*="youtu.be"]:before {
            content: "‚ñ∂";
            font-size: 1rem;
            color: #dc2626;
            font-weight: bold;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.25rem;
        }

        .message-bubble .text-gray-800 a[href*="youtube.com"]:after,
        .message-bubble .text-gray-800 a[href*="youtu.be"]:after {
            content: "üé•";
            font-size: 1rem;
            margin-left: 0.25rem;
        }

        /* Enhanced markdown formatting */
        .message-bubble .text-gray-800 {
            line-height: 1.7;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Paragraphs */
        .message-bubble .text-gray-800 p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .message-bubble .text-gray-800 p:last-child {
            margin-bottom: 0;
        }

        /* Headers */
        .message-bubble .text-gray-800 h1,
        .message-bubble .text-gray-800 h2,
        .message-bubble .text-gray-800 h3,
        .message-bubble .text-gray-800 h4 {
            font-weight: 700;
            color: #1f2937;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .message-bubble .text-gray-800 h1:first-child,
        .message-bubble .text-gray-800 h2:first-child,
        .message-bubble .text-gray-800 h3:first-child,
        .message-bubble .text-gray-800 h4:first-child {
            margin-top: 0;
        }

        .message-bubble .text-gray-800 h1 { font-size: 1.5rem; }
        .message-bubble .text-gray-800 h2 { font-size: 1.3rem; }
        .message-bubble .text-gray-800 h3 { font-size: 1.1rem; }
        .message-bubble .text-gray-800 h4 { font-size: 1rem; }

        /* Bold text - INLINE not block */
        .message-bubble .text-gray-800 strong {
            font-weight: 600;
            color: #1f2937;
            display: inline;
        }

        /* List styling */
        .message-bubble .text-gray-800 ul,
        .message-bubble .text-gray-800 ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .message-bubble .text-gray-800 ul {
            list-style-type: disc;
        }

        .message-bubble .text-gray-800 ol {
            list-style-type: decimal;
        }

        .message-bubble .text-gray-800 li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
            padding-left: 0.25rem;
        }

        /* Blockquotes */
        .message-bubble .text-gray-800 blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #4b5563;
            background-color: rgba(59, 130, 246, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
        }

        /* Code blocks */
        .message-bubble .text-gray-800 code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-bubble .text-gray-800 pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .message-bubble .text-gray-800 pre code {
            background: none;
            padding: 0;
        }

        /* Regular links styling */
        .message-bubble .text-gray-800 a:not([href*="youtube.com"]):not([href*="youtu.be"]) {
            color: #3b82f6;
            text-decoration: underline;
            text-decoration-color: rgba(59, 130, 246, 0.3);
            text-underline-offset: 0.125rem;
            transition: all 0.2s ease;
        }

        .message-bubble .text-gray-800 a:not([href*="youtube.com"]):not([href*="youtu.be"]):hover {
            color: #1d4ed8;
            text-decoration-color: #1d4ed8;
        }

        /* RESPONSE CARD STYLES */
        .response-cards {
            margin: 1rem 0;
        }

        .response-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .response-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease;
        }

        .card-header:hover {
            background-color: #f9fafb;
        }

        .card-summary {
            flex: 1;
            font-weight: 600;
            color: #374151;
            line-height: 1.5;
            margin-right: 1rem;
        }

        .card-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: #f3f4f6;
            transition: all 0.2s ease;
        }

        .card-header:hover .card-toggle {
            background-color: #e5e7eb;
        }

        .toggle-icon {
            font-size: 0.875rem;
            color: #6b7280;
            transition: transform 0.3s ease;
            font-weight: bold;
        }

        .response-card.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .card-details {
            border-top: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card-details.collapsed {
            max-height: 0;
            border-top: none;
        }

        .card-details.expanded {
            max-height: none;
        }

        .card-content {
            padding: 1.5rem;
            background-color: #fafbfc;
        }

        /* Intro message styling */
        .intro-message {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }

        /* Follow-up suggestions styling */
        .follow-up-suggestions {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .follow-up-suggestions h4 {
            margin: 0 0 0.75rem 0;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .suggestions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .suggestion-item {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            color: #4b5563;
        }

        .suggestion-item:hover {
            background-color: #f0f9ff;
            border-color: #3b82f6;
            color: #1e40af;
            transform: translateY(-1px);
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        /* Error fallback styling */
        .error-fallback {
            padding: 1rem;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            color: #dc2626;
        }

        /* Connection status */
        .connection-status-connected {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }

        .connection-status-disconnected {
            background-color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Colorful Starter prompt buttons */
        .starter-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .starter-prompt-btn {
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 2rem;
            font-weight: 500;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .starter-prompt-btn:hover {
            transform: translateY(-2px);
        }

        /* Healthcare - Blue/Teal */
        .starter-prompt-btn.healthcare {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }

        .starter-prompt-btn.healthcare:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
        }

        /* Water - Green/Emerald */
        .starter-prompt-btn.water {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .starter-prompt-btn.water:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        /* Tourism - Orange/Amber */
        .starter-prompt-btn.tourism {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .starter-prompt-btn.tourism:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
        }

        /* Economic - Purple/Violet */
        .starter-prompt-btn.economic {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .starter-prompt-btn.economic:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        /* Chat input area styling */
        .chat-input-area {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 1.5rem;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .thinking-dots-container {
                margin-left: 36px;
            }

            .card-header {
                padding: 0.75rem;
            }

            .card-content {
                padding: 1rem;
            }

            .card-summary {
                font-size: 0.9rem;
                margin-right: 0.5rem;
            }

            .starter-prompts {
                gap: 0.5rem;
            }

            .starter-prompt-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .chat-input-area {
                padding: 1rem;
            }
        }

        @media (max-width: 640px) {
            .thinking-dots-container {
                margin-left: 0;
            }

            .response-card {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen gradient-bg">
    <header class="bg-gradient-to-r from-white via-gray-50 to-white border-b border-gray-200 text-gray-800 shadow-xl">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">YuhHearDem</h1>
                    <p class="text-gray-600 mt-1">No more long talk - get straight to what dey really say</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-400 mr-2"></div>
                        <span class="text-sm">Connected</span>
                    </div>
                    <button id="clearChat" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors border border-gray-300">Clear Chat</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Welcome Section -->
        <div class="mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-semibold">YH</div>
                    <div class="flex-1">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Ask About Barbadian Politics
                        </h2>
                        <p class="text-gray-800 mb-2">
                            Hey! I'm YuhHearDem<img src="https://flagcdn.com/w20/bb.png" alt="Barbados Flag" style="width: 20px; height: 14px; display: inline-block; margin-left: 4px;"> Your AI guide to what's happening in Barbados' Parliament. From debates to decisions, I‚Äôm here to help you stay informed and involved. Ask me anything ‚Äî it‚Äôs your right to know!
                        </p>
                        <p class="text-gray-600 text-sm mb-2"><strong>Examples:</strong> "What did the Minister of Health say about COVID-19?" or "Recent discussions about water management"</p>

                        
                        <!-- Colorful Starter Prompts -->
                        <div class="starter-prompts">
                            <button class="starter-prompt-btn healthcare" onclick="sendSuggestion('What did the Minister of Health say recently?')">
                                üè• Healthcare Policy
                            </button>
                            <button class="starter-prompt-btn water" onclick="sendSuggestion('Recent discussions about water management')">
                                üíß Water Management
                            </button>
                            <button class="starter-prompt-btn tourism" onclick="sendSuggestion('What bills were discussed about tourism development?')">
                                üèñÔ∏è Tourism Development
                            </button>
                            <button class="starter-prompt-btn economic" onclick="sendSuggestion('Recent parliamentary debates on economic reform')">
                                üìà Economic Reform
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatContainer" class="space-y-4 mb-6">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area rounded-lg shadow-lg border border-gray-200">
            <div class="flex space-x-3">
                <input type="text" id="queryInput" placeholder="Ask about parliamentary discussions, ministers, bills, or policies..." class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                <button id="sendButton" class="bg-gradient-to-r from-emerald-300 to-green-400 hover:from-emerald-400 hover:to-green-500 disabled:from-gray-400 disabled:to-gray-500 text-white px-6 py-3 rounded-lg font-semibold transition-colors disabled:cursor-not-allowed flex items-center space-x-2 shadow-lg hover:shadow-xl" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <span>Send</span>
                </button>
            </div>
            <div id="inputStatus" class="text-sm text-gray-500 mt-2">Connecting to YuhHearDem service...</div>
        </div>
        
        <!-- Session Info -->
        <div class="text-center text-sm text-gray-500 mt-4">
            <span id="sessionInfo">Session ID: <span id="sessionId">Generating...</span> | User ID: <span id="userId">Generating...</span></span>
            <span id="sessionStatus" class="ml-2 px-2 py-1 rounded text-xs"></span>
        </div>
    </div>

    <script>
        // YuhHearDem Chat Application with Expandable Cards Support
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0;
                var v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Global function to toggle cards
        function toggleCard(cardId) {
            var card = document.querySelector('[data-card-id="' + cardId + '"]');
            var details = document.getElementById(cardId + '-details');
            
            if (!card || !details) {
                console.error('Card elements not found:', cardId);
                return;
            }
            
            if (details.classList.contains('collapsed')) {
                // Expand
                details.classList.remove('collapsed');
                details.classList.add('expanded');
                card.classList.add('expanded');
                console.log('üìÇ Expanded card:', cardId);
            } else {
                // Collapse
                details.classList.remove('expanded');
                details.classList.add('collapsed');
                card.classList.remove('expanded');
                console.log('üìÅ Collapsed card:', cardId);
            }
        }

        // Global function to send suggestion
        function sendSuggestion(suggestion) {
            console.log('üí° Sending suggestion:', suggestion);
            if (chatApp && chatApp.elements && chatApp.elements.queryInput) {
                chatApp.elements.queryInput.value = suggestion;
                chatApp.sendQuery();
            }
        }

        var chatApp = {
            // Configuration
            apiBase: 'https://yuhheardem-chatbot-1074852466398.us-east1.run.app',
            userId: null,
            sessionId: null,
            isProcessing: false,
            currentThinkingDots: null,
            messageCounter: 0,
            
            // DOM elements
            elements: {
                chatContainer: null,
                queryInput: null,
                sendButton: null,
                inputStatus: null,
                connectionStatus: null,
                clearButton: null
            },
            
            init: function() {
                console.log('üîß Initializing YuhHearDem chat with expandable cards...');
                
                this.initializeSession();
                this.cacheElements();
                this.displaySessionInfo();
                this.testConnection();
                this.setupEventListeners();
            },
            
            cacheElements: function() {
                this.elements.chatContainer = document.getElementById('chatContainer');
                this.elements.queryInput = document.getElementById('queryInput');
                this.elements.sendButton = document.getElementById('sendButton');
                this.elements.inputStatus = document.getElementById('inputStatus');
                this.elements.connectionStatus = document.getElementById('connectionStatus');
                this.elements.clearButton = document.getElementById('clearChat');
            },
            
            initializeSession: function() {
                var existingUserId = sessionStorage.getItem('yuhheardem_user_id');
                var existingSessionId = sessionStorage.getItem('yuhheardem_session_id');
                
                if (existingUserId && existingSessionId) {
                    this.userId = existingUserId;
                    this.sessionId = existingSessionId;
                    this.setSessionStatus('Session Restored', 'success');
                } else {
                    this.userId = generateUUID();
                    this.sessionId = generateUUID();
                    
                    sessionStorage.setItem('yuhheardem_user_id', this.userId);
                    sessionStorage.setItem('yuhheardem_session_id', this.sessionId);
                    this.setSessionStatus('New Session', 'new');
                }
            },
            
            displaySessionInfo: function() {
                document.getElementById('sessionId').textContent = this.sessionId.substring(0, 8) + '...';
                document.getElementById('userId').textContent = this.userId.substring(0, 8) + '...';
            },
            
            setSessionStatus: function(text, type) {
                var sessionStatus = document.getElementById('sessionStatus');
                sessionStatus.textContent = text;
                
                var className = 'ml-2 px-2 py-1 rounded text-xs ';
                switch(type) {
                    case 'success':
                        className += 'bg-green-100 text-green-800';
                        break;
                    case 'new':
                        className += 'bg-blue-100 text-blue-800';
                        break;
                    case 'error':
                        className += 'bg-red-100 text-red-800';
                        break;
                    default:
                        className += 'bg-gray-100 text-gray-800';
                }
                sessionStatus.className = className;
            },
            
            testConnection: function() {
                var self = this;
                fetch(this.apiBase + '/health')
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Health check failed: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(health) {
                        if (health.status === 'healthy') {
                            self.setConnectionStatus(true);
                            self.enableInput();
                            self.elements.inputStatus.textContent = 'Ready! Ask me about parliamentary discussions.';
                        } else {
                            throw new Error('Service not healthy: ' + health.status);
                        }
                    })
                    .catch(function(error) {
                        console.error('‚ùå Connection failed:', error);
                        self.setConnectionStatus(false);
                        self.elements.inputStatus.textContent = 'Connection failed: ' + error.message;
                    });
            },
            
            setupEventListeners: function() {
                var self = this;
                
                this.elements.sendButton.addEventListener('click', function() {
                    self.sendQuery();
                });
                
                this.elements.queryInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        self.sendQuery();
                    }
                });
                
                this.elements.clearButton.addEventListener('click', function() {
                    self.clearChat();
                });
            },
            
            setConnectionStatus: function(connected) {
                var statusDot = this.elements.connectionStatus.querySelector('div');
                var statusText = this.elements.connectionStatus.querySelector('span');
                
                if (connected) {
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-400 mr-2 connection-status-connected';
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-400 mr-2 connection-status-disconnected';
                    statusText.textContent = 'Disconnected';
                }
            },
            
            enableInput: function() {
                this.elements.queryInput.disabled = false;
                this.elements.sendButton.disabled = false;
                this.elements.queryInput.focus();
            },
            
            disableInput: function() {
                this.elements.queryInput.disabled = true;
                this.elements.sendButton.disabled = true;
            },
            
            showThinkingDots: function() {
                this.hideThinkingDots();
                
                console.log('üé≠ Showing thinking dots');
                
                var dotsContainer = document.createElement('div');
                dotsContainer.className = 'thinking-dots-container fade-in';
                dotsContainer.innerHTML = 
                    '<div class="thinking-dots">' +
                        '<div class="thinking-dot"></div>' +
                        '<div class="thinking-dot"></div>' +
                        '<div class="thinking-dot"></div>' +
                    '</div>';
                
                this.elements.chatContainer.appendChild(dotsContainer);
                this.currentThinkingDots = dotsContainer;
                this.scrollToBottom();
                
                return dotsContainer;
            },
            
            hideThinkingDots: function() {
                if (this.currentThinkingDots) {
                    console.log('üé≠ Hiding thinking dots');
                    var dots = this.currentThinkingDots;
                    dots.classList.add('fade-out');
                    
                    setTimeout(function() {
                        if (dots.parentNode) {
                            dots.parentNode.removeChild(dots);
                        }
                    }, 300);
                    
                    this.currentThinkingDots = null;
                }
            },
            
            sendQuery: function() {
                var query = this.elements.queryInput.value.trim();
                if (!query || this.isProcessing) return;
                
                console.log('üöÄ Sending query:', query);
                
                this.isProcessing = true;
                this.disableInput();
                
                // Add user message
                this.addMessage('user', query);
                this.elements.queryInput.value = '';
                
                // Show thinking dots immediately
                this.showThinkingDots();
                
                // Start stream
                this.streamQuery(query);
            },
            
            streamQuery: function(query) {
                var self = this;
                
                fetch(this.apiBase + '/query/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        user_id: this.userId,
                        session_id: this.sessionId
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.body.getReader();
                })
                .then(function(reader) {
                    var decoder = new TextDecoder();
                    var buffer = '';
                    
                    function readStream() {
                        return reader.read().then(function(result) {
                            if (result.done) {
                                console.log('üèÅ Stream finished');
                                self.hideThinkingDots();
                                self.isProcessing = false;
                                self.enableInput();
                                return;
                            }
                            
                            buffer += decoder.decode(result.value, { stream: true });
                            var lines = buffer.split('\n');
                            buffer = lines.pop();
                            
                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i];
                                if (line.startsWith('data: ')) {
                                    try {
                                        var eventData = JSON.parse(line.substring(6));
                                        console.log('üì® Event:', eventData.type);
                                        
                                        // Handle final response
                                        if (eventData.type === 'response_ready' && eventData.data && eventData.data.response) {
                                            console.log('‚úÖ Got final response, type:', eventData.data.response_type);
                                            self.hideThinkingDots();
                                            
                                            // Check if we have structured response
                                            if (eventData.data.structured_response) {
                                                console.log('üìã Processing structured response with cards');
                                                self.addStructuredMessage(eventData.data.structured_response, eventData.data.response);
                                            } else {
                                                console.log('üìÑ Processing fallback response');
                                                self.addMessage('assistant', eventData.data.response);
                                            }
                                            
                                        } else if (eventData.type === 'error') {
                                            console.log('‚ùå Got error');
                                            self.hideThinkingDots();
                                            self.addMessage('assistant', 'Error: ' + eventData.message);
                                        } else {
                                            console.log('üîÑ Ignoring event type:', eventData.type);
                                        }
                                        
                                    } catch (e) {
                                        console.error('‚ùå Parse error:', e);
                                    }
                                }
                            }
                            
                            return readStream();
                        });
                    }
                    
                    return readStream();
                })
                .catch(function(error) {
                    console.error('‚ùå Stream failed:', error);
                    self.hideThinkingDots();
                    self.addMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
                    self.isProcessing = false;
                    self.enableInput();
                });
            },
            
            addStructuredMessage: function(structuredResponse, htmlContent) {
                console.log('üí¨ Adding structured message with cards');
                
                // Generate unique message ID
                this.messageCounter++;
                var messageId = 'msg-' + this.messageCounter;
                
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message-bubble';
                messageDiv.setAttribute('data-message-id', messageId);
                
                var avatarBg = 'bg-blue-500';
                var bubbleBg = 'bg-blue-50 border border-blue-200';
                var avatarText = 'YH';
                
                messageDiv.innerHTML = 
                    '<div class="rounded-lg p-6 ' + bubbleBg + '">' +
                        '<div class="flex items-start space-x-3">' +
                            '<div class="w-10 h-10 rounded-full ' + avatarBg + ' flex items-center justify-center text-white text-sm font-semibold">' + avatarText + '</div>' +
                            '<div class="flex-1">' +
                                '<div class="text-gray-800">' + htmlContent + '</div>' +
                                '<div class="text-xs text-gray-500 mt-3">' + new Date().toLocaleTimeString() + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                this.elements.chatContainer.appendChild(messageDiv);
                
                // Make YouTube links open in new window
                var youtubeLinks = messageDiv.querySelectorAll('a[href*="youtube.com"], a[href*="youtu.be"]');
                for (var i = 0; i < youtubeLinks.length; i++) {
                    youtubeLinks[i].target = '_blank';
                    youtubeLinks[i].rel = 'noopener noreferrer';
                }
                
                this.scrollToBottom();
                
                return messageDiv;
            },
            
            addMessage: function(sender, content) {
                console.log('üí¨ Adding message:', sender, content.substring(0, 50) + '...');
                
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message-bubble';
                
                var isUser = sender === 'user';
                var avatarBg = isUser ? 'bg-green-500' : 'bg-blue-500';
                var bubbleBg = isUser ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200';
                var avatarText = isUser ? 'U' : 'YH';
                
                var htmlContent;
                if (isUser) {
                    htmlContent = this.escapeHtml(content).replace(/\n/g, '<br>');
                } else {
                    // Parse markdown for assistant responses
                    try {
                        // Configure marked for better formatting
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            sanitize: false
                        });
                        htmlContent = marked.parse(content);
                    } catch (e) {
                        console.error('Markdown parsing error:', e);
                        htmlContent = this.escapeHtml(content).replace(/\n/g, '<br>');
                    }
                }
                
                var reverseClass = isUser ? 'flex-row-reverse space-x-reverse' : '';
                
                messageDiv.innerHTML = 
                    '<div class="rounded-lg p-6 ' + bubbleBg + '">' +
                        '<div class="flex items-start space-x-3 ' + reverseClass + '">' +
                            '<div class="w-10 h-10 rounded-full ' + avatarBg + ' flex items-center justify-center text-white text-sm font-semibold">' + avatarText + '</div>' +
                            '<div class="flex-1">' +
                                '<div class="text-gray-800">' + htmlContent + '</div>' +
                                '<div class="text-xs text-gray-500 mt-3">' + new Date().toLocaleTimeString() + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                this.elements.chatContainer.appendChild(messageDiv);
                
                // Make YouTube links open in new window
                if (!isUser) {
                    var youtubeLinks = messageDiv.querySelectorAll('a[href*="youtube.com"], a[href*="youtu.be"]');
                    for (var i = 0; i < youtubeLinks.length; i++) {
                        youtubeLinks[i].target = '_blank';
                        youtubeLinks[i].rel = 'noopener noreferrer';
                    }
                }
                
                this.scrollToBottom();
                
                return messageDiv;
            },
            
            escapeHtml: function(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            scrollToBottom: function() {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            },
            
            clearChat: function() {
                // Clear all messages
                this.elements.chatContainer.innerHTML = '';
                
                // Reset message counter
                this.messageCounter = 0;
                
                this.userId = generateUUID();
                this.sessionId = generateUUID();
                
                sessionStorage.setItem('yuhheardem_user_id', this.userId);
                sessionStorage.setItem('yuhheardem_session_id', this.sessionId);
                
                this.displaySessionInfo();
                this.setSessionStatus('New Session', 'new');
                
                this.elements.queryInput.focus();
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            chatApp.init();
        });

        // Expose functions globally
        window.chatApp = chatApp;
        window.toggleCard = toggleCard;
        window.sendSuggestion = sendSuggestion;
    </script>
</body>
</html>