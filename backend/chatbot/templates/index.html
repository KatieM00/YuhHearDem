<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YuhHearDem - Parliamentary Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Clean YuhHearDem Styles */
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-container {
            height: calc(100vh - 280px);
        }

        /* Thinking dots animation */
        .thinking-dots-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 1rem 0;
            margin-left: 44px;
        }

        .thinking-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: #64748b;
            border-radius: 50%;
            animation: thinking-bounce 1.4s ease-in-out infinite;
        }

        .thinking-dot:nth-child(1) { animation-delay: 0s; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes thinking-bounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-12px);
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* YouTube link styling */
        .message-bubble .text-gray-800 a[href*="youtube.com"],
        .message-bubble .text-gray-800 a[href*="youtu.be"] {
            color: #dc2626;
            text-decoration: none;
            border-bottom: 2px dashed #dc2626;
            transition: all 0.2s ease;
        }

        .message-bubble .text-gray-800 a[href*="youtube.com"]:hover,
        .message-bubble .text-gray-800 a[href*="youtu.be"]:hover {
            background-color: rgba(220, 38, 38, 0.1);
            transform: translateY(-1px);
        }

        .message-bubble .text-gray-800 a[href*="youtube.com"]:after,
        .message-bubble .text-gray-800 a[href*="youtu.be"]:after {
            content: " ▶";
            font-size: 0.9em;
            color: #dc2626;
            margin-left: 2px;
        }

        /* Enhanced markdown formatting */
        .message-bubble .text-gray-800 {
            line-height: 1.7;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Paragraphs */
        .message-bubble .text-gray-800 p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .message-bubble .text-gray-800 p:last-child {
            margin-bottom: 0;
        }

        /* Headers */
        .message-bubble .text-gray-800 h1,
        .message-bubble .text-gray-800 h2,
        .message-bubble .text-gray-800 h3,
        .message-bubble .text-gray-800 h4 {
            font-weight: 700;
            color: #1f2937;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .message-bubble .text-gray-800 h1:first-child,
        .message-bubble .text-gray-800 h2:first-child,
        .message-bubble .text-gray-800 h3:first-child,
        .message-bubble .text-gray-800 h4:first-child {
            margin-top: 0;
        }

        .message-bubble .text-gray-800 h1 { font-size: 1.5rem; }
        .message-bubble .text-gray-800 h2 { font-size: 1.3rem; }
        .message-bubble .text-gray-800 h3 { font-size: 1.1rem; }
        .message-bubble .text-gray-800 h4 { font-size: 1rem; }

        /* Bold text - INLINE not block */
        .message-bubble .text-gray-800 strong {
            font-weight: 600;
            color: #1f2937;
            display: inline;
        }

        /* List styling */
        .message-bubble .text-gray-800 ul,
        .message-bubble .text-gray-800 ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .message-bubble .text-gray-800 ul {
            list-style-type: disc;
        }

        .message-bubble .text-gray-800 ol {
            list-style-type: decimal;
        }

        .message-bubble .text-gray-800 li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
            padding-left: 0.25rem;
        }

        /* Blockquotes */
        .message-bubble .text-gray-800 blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #4b5563;
            background-color: rgba(59, 130, 246, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
        }

        /* Code blocks */
        .message-bubble .text-gray-800 code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-bubble .text-gray-800 pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .message-bubble .text-gray-800 pre code {
            background: none;
            padding: 0;
        }

        /* Connection status */
        .connection-status-connected {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }

        .connection-status-disconnected {
            background-color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 250px);
            }
            
            .thinking-dots-container {
                margin-left: 36px;
            }
        }

        @media (max-width: 640px) {
            .thinking-dots-container {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">YuhHearDem</h1>
                    <p class="text-blue-100 mt-1">AI Parliamentary Research Assistant for Barbados</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-400 mr-2"></div>
                        <span class="text-sm">Connected</span>
                    </div>
                    <button id="clearChat" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">Clear Chat</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-6 pb-4">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <div id="chatContainer" class="chat-container overflow-y-auto p-6 space-y-4">
                <div class="message-bubble">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-semibold">YH</div>
                        <div class="flex-1">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-gray-800">Hello! I'm YuhHearDem, your AI assistant for researching Barbados Parliament discussions. Ask me about parliamentary debates, minister statements, bills, or any topic discussed in Parliament.</p>
                                <p class="text-gray-600 text-sm mt-2"><strong>Examples:</strong> "What did the Minister of Health say about COVID-19?" or "Recent discussions about water management"</p>
                                <p class="text-gray-600 text-sm mt-2"><strong>YouTube:</strong> When I share YouTube links with timestamps, click them to watch the video in the side panel!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="border-t p-4 bg-white">
                <div class="flex space-x-3">
                    <input type="text" id="queryInput" placeholder="Ask about parliamentary discussions, ministers, bills, or policies..." class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                    <button id="sendButton" class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors disabled:cursor-not-allowed" disabled>Send</button>
                </div>
                <div id="inputStatus" class="text-sm text-gray-500 mt-2">Connecting to YuhHearDem service...</div>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 pb-4">
            <span id="sessionInfo">Session ID: <span id="sessionId">Generating...</span> | User ID: <span id="userId">Generating...</span></span>
            <span id="sessionStatus" class="ml-2 px-2 py-1 rounded text-xs"></span>
        </div>
    </div>

    <script>
        // Clean YuhHearDem Chat Application - No Old Code
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0;
                var v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        var chatApp = {
            // Configuration
            apiBase: window.location.origin,
            userId: null,
            sessionId: null,
            isProcessing: false,
            currentThinkingDots: null,
            
            // DOM elements
            elements: {
                chatContainer: null,
                queryInput: null,
                sendButton: null,
                inputStatus: null,
                connectionStatus: null,
                clearButton: null
            },
            
            init: function() {
                console.log('🔧 Initializing clean YuhHearDem chat...');
                
                this.initializeSession();
                this.cacheElements();
                this.displaySessionInfo();
                this.testConnection();
                this.setupEventListeners();
            },
            
            cacheElements: function() {
                this.elements.chatContainer = document.getElementById('chatContainer');
                this.elements.queryInput = document.getElementById('queryInput');
                this.elements.sendButton = document.getElementById('sendButton');
                this.elements.inputStatus = document.getElementById('inputStatus');
                this.elements.connectionStatus = document.getElementById('connectionStatus');
                this.elements.clearButton = document.getElementById('clearChat');
            },
            
            initializeSession: function() {
                var existingUserId = sessionStorage.getItem('yuhheardem_user_id');
                var existingSessionId = sessionStorage.getItem('yuhheardem_session_id');
                
                if (existingUserId && existingSessionId) {
                    this.userId = existingUserId;
                    this.sessionId = existingSessionId;
                    this.setSessionStatus('Session Restored', 'success');
                } else {
                    this.userId = generateUUID();
                    this.sessionId = generateUUID();
                    
                    sessionStorage.setItem('yuhheardem_user_id', this.userId);
                    sessionStorage.setItem('yuhheardem_session_id', this.sessionId);
                    this.setSessionStatus('New Session', 'new');
                }
            },
            
            displaySessionInfo: function() {
                document.getElementById('sessionId').textContent = this.sessionId.substring(0, 8) + '...';
                document.getElementById('userId').textContent = this.userId.substring(0, 8) + '...';
            },
            
            setSessionStatus: function(text, type) {
                var sessionStatus = document.getElementById('sessionStatus');
                sessionStatus.textContent = text;
                
                var className = 'ml-2 px-2 py-1 rounded text-xs ';
                switch(type) {
                    case 'success':
                        className += 'bg-green-100 text-green-800';
                        break;
                    case 'new':
                        className += 'bg-blue-100 text-blue-800';
                        break;
                    case 'error':
                        className += 'bg-red-100 text-red-800';
                        break;
                    default:
                        className += 'bg-gray-100 text-gray-800';
                }
                sessionStatus.className = className;
            },
            
            testConnection: function() {
                fetch(this.apiBase + '/health')
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Health check failed: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(health) {
                        if (health.status === 'healthy') {
                            chatApp.setConnectionStatus(true);
                            chatApp.enableInput();
                            chatApp.elements.inputStatus.textContent = 'Ready! Ask me about parliamentary discussions.';
                        } else {
                            throw new Error('Service not healthy: ' + health.status);
                        }
                    })
                    .catch(function(error) {
                        console.error('❌ Connection failed:', error);
                        chatApp.setConnectionStatus(false);
                        chatApp.elements.inputStatus.textContent = 'Connection failed: ' + error.message;
                    });
            },
            
            setupEventListeners: function() {
                var self = this;
                
                this.elements.sendButton.addEventListener('click', function() {
                    self.sendQuery();
                });
                
                this.elements.queryInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        self.sendQuery();
                    }
                });
                
                this.elements.clearButton.addEventListener('click', function() {
                    self.clearChat();
                });
            },
            
            setConnectionStatus: function(connected) {
                var statusDot = this.elements.connectionStatus.querySelector('div');
                var statusText = this.elements.connectionStatus.querySelector('span');
                
                if (connected) {
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-400 mr-2 connection-status-connected';
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-400 mr-2 connection-status-disconnected';
                    statusText.textContent = 'Disconnected';
                }
            },
            
            enableInput: function() {
                this.elements.queryInput.disabled = false;
                this.elements.sendButton.disabled = false;
                this.elements.queryInput.focus();
            },
            
            disableInput: function() {
                this.elements.queryInput.disabled = true;
                this.elements.sendButton.disabled = true;
            },
            
            showThinkingDots: function() {
                this.hideThinkingDots();
                
                console.log('🎭 Showing thinking dots');
                
                var dotsContainer = document.createElement('div');
                dotsContainer.className = 'thinking-dots-container fade-in';
                dotsContainer.innerHTML = 
                    '<div class="thinking-dots">' +
                        '<div class="thinking-dot"></div>' +
                        '<div class="thinking-dot"></div>' +
                        '<div class="thinking-dot"></div>' +
                    '</div>';
                
                this.elements.chatContainer.appendChild(dotsContainer);
                this.currentThinkingDots = dotsContainer;
                this.scrollToBottom();
                
                return dotsContainer;
            },
            
            hideThinkingDots: function() {
                if (this.currentThinkingDots) {
                    console.log('🎭 Hiding thinking dots');
                    var dots = this.currentThinkingDots;
                    dots.classList.add('fade-out');
                    
                    setTimeout(function() {
                        if (dots.parentNode) {
                            dots.parentNode.removeChild(dots);
                        }
                    }, 300);
                    
                    this.currentThinkingDots = null;
                }
            },
            
            sendQuery: function() {
                var query = this.elements.queryInput.value.trim();
                if (!query || this.isProcessing) return;
                
                console.log('🚀 Sending query:', query);
                
                this.isProcessing = true;
                this.disableInput();
                
                // Add user message
                this.addMessage('user', query);
                this.elements.queryInput.value = '';
                
                // Show thinking dots immediately
                this.showThinkingDots();
                
                // Start stream
                this.streamQuery(query);
            },
            
            streamQuery: function(query) {
                var self = this;
                
                fetch(this.apiBase + '/query/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        user_id: this.userId,
                        session_id: this.sessionId
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.body.getReader();
                })
                .then(function(reader) {
                    var decoder = new TextDecoder();
                    var buffer = '';
                    
                    function readStream() {
                        return reader.read().then(function(result) {
                            if (result.done) {
                                console.log('🏁 Stream finished');
                                self.hideThinkingDots();
                                self.isProcessing = false;
                                self.enableInput();
                                return;
                            }
                            
                            buffer += decoder.decode(result.value, { stream: true });
                            var lines = buffer.split('\n');
                            buffer = lines.pop();
                            
                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i];
                                if (line.startsWith('data: ')) {
                                    try {
                                        var eventData = JSON.parse(line.substring(6));
                                        console.log('📨 Event:', eventData.type);
                                        
                                        // ONLY handle final response - ignore everything else
                                        if (eventData.type === 'response_ready' && eventData.data && eventData.data.response) {
                                            console.log('✅ Got final response');
                                            self.hideThinkingDots();
                                            self.addMessage('assistant', eventData.data.response);
                                            
                                        } else if (eventData.type === 'error') {
                                            console.log('❌ Got error');
                                            self.hideThinkingDots();
                                            self.addMessage('assistant', 'Error: ' + eventData.message);
                                        } else {
                                            console.log('🔄 Ignoring event type:', eventData.type);
                                        }
                                        
                                    } catch (e) {
                                        console.error('❌ Parse error:', e);
                                    }
                                }
                            }
                            
                            return readStream();
                        });
                    }
                    
                    return readStream();
                })
                .catch(function(error) {
                    console.error('❌ Stream failed:', error);
                    self.hideThinkingDots();
                    self.addMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
                    self.isProcessing = false;
                    self.enableInput();
                });
            },
            
            addMessage: function(sender, content) {
                console.log('💬 Adding message:', sender, content.substring(0, 50) + '...');
                
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message-bubble';
                
                var isUser = sender === 'user';
                var avatarBg = isUser ? 'bg-green-500' : 'bg-blue-500';
                var bubbleBg = isUser ? 'bg-green-50' : 'bg-blue-50';
                var avatarText = isUser ? 'U' : 'YH';
                
                var htmlContent;
                if (isUser) {
                    htmlContent = this.escapeHtml(content).replace(/\n/g, '<br>');
                } else {
                    // Parse markdown for assistant responses
                    try {
                        // Configure marked for better formatting
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            sanitize: false
                        });
                        htmlContent = marked.parse(content);
                    } catch (e) {
                        console.error('Markdown parsing error:', e);
                        htmlContent = this.escapeHtml(content).replace(/\n/g, '<br>');
                    }
                }
                
                var reverseClass = isUser ? 'flex-row-reverse space-x-reverse' : '';
                
                messageDiv.innerHTML = 
                    '<div class="flex items-start space-x-3 ' + reverseClass + '">' +
                        '<div class="w-8 h-8 rounded-full ' + avatarBg + ' flex items-center justify-center text-white text-sm font-semibold">' + avatarText + '</div>' +
                        '<div class="flex-1">' +
                            '<div class="' + bubbleBg + ' rounded-lg p-4">' +
                                '<div class="text-gray-800">' + htmlContent + '</div>' +
                                '<div class="text-xs text-gray-500 mt-2">' + new Date().toLocaleTimeString() + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                this.elements.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                return messageDiv;
            },
            
            escapeHtml: function(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            scrollToBottom: function() {
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            },
            
            clearChat: function() {
                var messages = this.elements.chatContainer.querySelectorAll('.message-bubble');
                for (var i = 1; i < messages.length; i++) {
                    messages[i].remove();
                }
                
                this.userId = generateUUID();
                this.sessionId = generateUUID();
                
                sessionStorage.setItem('yuhheardem_user_id', this.userId);
                sessionStorage.setItem('yuhheardem_session_id', this.sessionId);
                
                this.displaySessionInfo();
                this.setSessionStatus('New Session', 'new');
                
                this.elements.queryInput.focus();
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            chatApp.init();
        });

        window.chatApp = chatApp;
    </script>
</body>
</html>